
Что такое роли Ansible?
-----------------------

Роли Ansible позволяют разрабатывать повторно используемые компоненты автоматизации путем группировки и инкапсуляции связанных артефактов автоматизации, таких как файлы конфигурации, шаблоны, задачи и обработчики. Поскольку роли изолируют эти компоненты, их проще использовать повторно и делиться ими с другими людьми.

Каковы преимущества ролей в Ansible?
------------------------------------

В Ansible роли — это метод автоматической загрузки определенных переменных, задач, файлов, шаблонов и обработчиков на основе известной файловой структуры. Группировка контента по ролям упрощает совместное использование и повторное использование. Документация Ansible по ролям описывает файловую структуру и другие соображения.

Как создать несколько ролей в Ansible?
--------------------------------------

Вы можете создать роль с помощью команды инициализации ansible-galaxy внутри /etc/ansible/roles. Вы увидите, что другие каталоги ролей также были созданы. Эти каталоги представляют собой задачи, обработчики, значения по умолчанию, переменные, файлы, шаблоны, метаданные и файл README.md.

  

(adsbygoogle = window.adsbygoogle || \[\]).push({});

Каковы примеры ролей?
---------------------

Например, школьный футболист выполняет роли ученика, спортсмена, одноклассника и т. д. Другой пример роли: «Человек в роли родителя должен заботиться о своем ребенке и защищать его от вреда».

В чем разница между ролями и разрешениями?
------------------------------------------

Разрешение предоставляет пользователям возможность выполнять действие с ресурсом на платформе WorkMarket. Роль представляет собой набор из одного или нескольких разрешений и может быть назначена пользователю для предоставления набора разрешений.

Что такое роли и разрешения?
----------------------------

Роли позволяют администраторам сообщества группировать разрешения и назначать их пользователям или группам пользователей. Разрешения определяют действия, которые пользователь может выполнять в сообществе. При назначении ролей администраторы сообщества рассматривают задачи пользователя в контексте конкретного сообщества.

Каково назначение ролей?
------------------------

Часто большинство людей назначают на должности, не зная в полной мере, за что они несут ответственность и за что подотчетны. Определенные роли и обязанности обеспечивают ясность, согласованность и ожидания для тех, кто выполняет работу и поддерживает работу нашего предприятия.

Roles
=====

Роли позволяют автоматически загружать связанные между собой вары,файлы,задачи,обработчики и другие артефакты Ansible на основе известной структуры файлов.После группировки содержимого в роли вы можете легко использовать его повторно и делиться им с другими пользователями.

*   [Структура каталога ролей](#role-directory-structure)
*   [Хранение и поиск ролей](#storing-and-finding-roles)
*   [Using roles](#using-roles)
    
    *   [Использование ролей на игровом уровне](#using-roles-at-the-play-level)
    *   [В том числе роли:динамическое повторное использование](#including-roles-dynamic-reuse)
    *   [Импортирующие роли:статическое повторное использование](#importing-roles-static-reuse)
*   [Проверка ролевых аргументов](#role-argument-validation)
    
    *   [Specification format](#specification-format)
    *   [Sample specification](?page=2#sample-specification)
*   [Запуск роли несколько раз в одной пьесе.](?page=2#running-a-role-multiple-times-in-one-playbook)
    
    *   [Передача различных параметров](?page=2#passing-different-parameters)
    *   [Использование `allow_duplicates: true`](?page=2#using-allow-duplicates-true)
*   [Использование ролевых зависимостей](?page=2#using-role-dependencies)
    
    *   [Многократные ролевые зависимости в одной пьесе.](?page=2#running-role-dependencies-multiple-times-in-one-playbook)
*   [Встраиваемые модули и плагины в ролях](?page=2#embedding-modules-and-plugins-in-roles)
*   [Разделение ролей:Допустимая Галактика](?page=2#sharing-roles-ansible-galaxy)

Структура каталога ролей
------------------------

Роль Ansible имеет определенную структуру каталогов с восемью основными стандартными каталогами.Вы должны включить хотя бы один из этих каталогов в каждую роль.Вы можете опустить любые каталоги,которые роль не использует.Например:

```
# playbooks
site.yml
webservers.yml
fooservers.yml
roles/
    common/
        tasks/
        handlers/
        library/
        files/
        templates/
        vars/
        defaults/
        meta/
    webservers/
        tasks/
        defaults/
        meta/
```
По умолчанию Ansible будет искать в каждом каталоге внутри роли файл `main.yml` для соответствующего содержимого (также `main.yaml` и `main` ):

*   `tasks/main.yml` - основной список задач, которые выполняет роль.
*   `handlers/main.yml` - обработчики, которые могут использоваться внутри или вне этой роли.
*   `library/my_module.py` - модули, которые можно использовать в рамках этой роли ( дополнительную информацию см. в разделе [Встраивание модулей и плагинов в роли ).](?page=2#embedding-modules-and-plugins-in-roles)
*   `defaults/main.yml` - переменные по умолчанию для роли (подробнее см. [Использование переменных](playbooks_variables#playbooks-variables) ). Эти переменные имеют самый низкий приоритет среди всех доступных переменных и могут быть легко заменены любой другой переменной, включая переменные инвентаризации.
*   `vars/main.yml` - другие переменные для роли (подробнее см. [Использование переменных](playbooks_variables#playbooks-variables) ).
*   `files/main.yml` - файлы, которые развертывает роль.
*   `templates/main.yml` - шаблоны, которые развертывает роль.
*   `meta/main.yml` - метаданные для роли, включая зависимости ролей.

Вы можете добавить другие файлы YAML в некоторые каталоги. Например, вы можете поместить задачи для конкретной платформы в отдельные файлы и ссылаться на них в файле `tasks/main.yml` :
```
# roles/example/tasks/main.yml
- name: Install the correct web server for RHEL
  import_tasks: redhat.yml
  when: ansible_facts['os_family']|lower == 'redhat'

- name: Install the correct web server for Debian
  import_tasks: debian.yml
  when: ansible_facts['os_family']|lower == 'debian'

# roles/example/tasks/redhat.yml
- name: Install web server
  ansible.builtin.yum:
    name: "httpd"
    state: present

# roles/example/tasks/debian.yml
- name: Install web server
  ansible.builtin.apt:
    name: "apache2"
    state: present
```
Роли также могут включать в себя модули и другие типы подключаемых модулей в каталоге с именем `library` . Дополнительные сведения см. в разделе [Встраивание модулей и подключаемых модулей в роли](?page=2#embedding-modules-and-plugins-in-roles) ниже.

Хранение и поиск ролей
----------------------

По умолчанию,Ansible ищет роли в двух местах:

*   в каталоге с именем `roles/` относительно файла playbook
*   in `/etc/ansible/roles`

Если вы храните свои роли в другом месте, установите параметр конфигурации [roles\_path](../../reference_appendices/config?page=5#default-roles-path) , чтобы Ansible мог найти ваши роли. Сохранение общих ролей в одном месте упрощает их использование в нескольких сборниках сценариев. Подробную информацию об управлении настройками в файле ansible.cfg см. в [разделе «Настройка Ansible» .](../installation_guide/intro_configuration#intro-configuration)

Кроме того,вы можете назвать роль с полностью квалифицированным путем:

```
---
- hosts: webservers
  roles:
    - role: '/path/to/my/roles/common'
```
Using roles
-----------

Вы можете использовать роли тремя способами:

*   на уровне игры с опцией `roles` : это классический способ использования ролей в игре.
*   на уровне задач с помощью `include_role` : вы можете повторно использовать роли динамически в любом месте раздела `tasks` игры, используя `include_role` .
*   на уровне задач с помощью `import_role` : вы можете повторно использовать роли статически в любом месте раздела `tasks` игры, используя `import_role` .

### Использование ролей на игровом уровне

\ способ использования ролей - это вариант `roles` для данной игры:

```
---
- hosts: webservers
  roles:
    - common
    - webservers
```

Когда вы используете опцию `roles` на уровне игры, для каждой роли «x»:

*   Если роли/x/tasks/main.yml существуют,Ansible добавляет задачи из этого файла в пьесу.
*   Если роли/x/обработчики/main.yml существуют,Ansible добавляет обработчики в этот файл в пьесу.
*   Если роли/x/vars/main.yml существуют,Ansible добавляет переменные из этого файла в пьесу.
*   Если роли/x/defaults/main.yml существуют,Ansible добавляет переменные из этого файла в плейбл.
*   Если роли/x/meta/main.yml существуют,Ansible добавляет любые зависимости ролей в этот файл в список ролей.
*   Любая копия,скрипт,шаблон или включаемые задачи (в роли)могут ссылаться на файлы в ролях/x/{файлы,шаблоны,задачи}/(dir зависит от задачи),без необходимости направлять их относительно или абсолютно.

Когда вы используете опцию `roles` на уровне игры, Ansible обрабатывает роли как статический импорт и обрабатывает их во время синтаксического анализа playbook. Ansible выполняет вашу пьесу в следующем порядке:

*   Любые `pre_tasks` , определенные в игре.
*   Любые обработчики,вызванные пре\_задачами.
*   Каждая роль указана в `roles:` , в указанном порядке. `meta/main.yml` роли, запускаются первыми, с учетом фильтрации тегов и условий. Дополнительные сведения см. в [разделе Использование зависимостей ролей .](?page=2#role-dependencies)
*   Любые `tasks` определенные в игре.
*   Любые обработчики,вызванные ролями или задачами.
*   Любые `post_tasks` , определенные в игре.
*   Любые обработчики,вызванные post\_tasks.

Note

Если вы используете теги с задачами в роли, не забудьте также пометить свои pre\_tasks, post\_tasks и зависимости ролей и передать их вместе, особенно если задачи до / после и зависимости ролей используются для мониторинга управления окнами простоя или балансировки нагрузки. См. [Теги](playbooks_tags#tags) для получения подробной информации о добавлении и использовании тегов.

Вы можете передать другие ключевые слова параметру `roles` :
```
---
- hosts: webservers
  roles:
    - common
    - role: foo_app_instance
      vars:
        dir: '/opt/a'
        app_port: 5000
      tags: typeA
    - role: foo_app_instance
      vars:
        dir: '/opt/b'
        app_port: 5001
      tags: typeB
```
Когда вы добавляете тег к параметру `role` , Ansible применяет тег ко ВСЕМ задачам внутри роли.

При использовании `vars:` в ​​разделе `roles:` playbook переменные добавляются к переменным play, что делает их доступными для всех задач в play до и после роли. Это поведение можно изменить с помощью [DEFAULT\_PRIVATE\_ROLE\_VARS](../../reference_appendices/config?page=5#default-private-role-vars) .

### В том числе роли:динамическое повторное использование

Вы можете повторно использовать роли динамически в любом месте раздела `tasks` игры, используя `include_role` . В то время как роли, добавленные в разделе `roles` выполняются перед любыми другими задачами в книге, включенные роли выполняются в том порядке, в котором они определены. Если перед задачей `include_role` есть другие задачи, они будут выполняться первыми.

Включая роль:
```
---
- hosts: webservers
  tasks:
    - name: Print a message
      ansible.builtin.debug:
        msg: "this task runs before the example role"

    - name: Include the example role
      include_role:
        name: example

    - name: Print a message
      ansible.builtin.debug:
        msg: "this task runs after the example role"
```
При включении ролей можно передавать и другие ключевые слова,в том числе переменные и теги:
```
---
- hosts: webservers
  tasks:
    - name: Include the foo_app_instance role
      include_role:
        name: foo_app_instance
      vars:
        dir: '/opt/a'
        app_port: 5000
      tags: typeA
  ...
```
Когда вы добавляете [тег](playbooks_tags#tags) в задачу `include_role` , Ansible применяет тег `only` к самому включению. Это означает, что вы можете передать `--tags` для запуска только выбранных задач из роли, если сами эти задачи имеют тот же тег, что и оператор include. Дополнительные сведения см. В разделе « [Выборочный запуск задач с тегами в повторно используемых файлах»](playbooks_tags#selective-reuse) .

Вы можете условно включить роль:
```
---
- hosts: webservers
  tasks:
    - name: Include the some_role role
      include_role:
        name: some_role
      when: "ansible_facts['os_family'] == 'RedHat'"
```
### Импортирующие роли:статическое повторное использование

Вы можете повторно использовать роли статически в любом месте раздела `tasks` игры, используя `import_role` . Поведение такое же, как и при использовании ключевого слова `roles` . Например:
```
---
- hosts: webservers
  tasks:
    - name: Print a message
      ansible.builtin.debug:
        msg: "before we run our role"

    - name: Import the example role
      import_role:
        name: example

    - name: Print a message
      ansible.builtin.debug:
        msg: "after we ran our role"
```
При импорте ролей можно передавать и другие ключевые слова,в том числе переменные и теги:
```
---
- hosts: webservers
  tasks:
    - name: Import the foo_app_instance role
      import_role:
        name: foo_app_instance
      vars:
        dir: '/opt/a'
        app_port: 5000
  ...
```
Когда вы добавляете тег к оператору `import_role` , Ansible применяет этот тег ко `all` задачам внутри роли. Подробнее см. [Наследование тегов: добавление тегов к нескольким задачам](playbooks_tags#tag-inheritance) .

Проверка ролевых аргументов
---------------------------

Начиная с версии 2.11, вы можете включить проверку аргумента роли на основе спецификации аргумента. Эта спецификация определена в файле `meta/argument_specs.yml` (или с `.yaml` файла .yaml ). Когда эта спецификация аргумента определена, в начале выполнения роли вставляется новая задача, которая проверяет параметры, предоставленные для роли, на соответствие спецификации. Если параметры не прошли проверку, роль не будет выполнена.

Note

Ansible также поддерживает спецификации ролей, определенные в файле ролей `meta/main.yml` . Однако любая роль, определяющая спецификации в этом файле, не будет работать в версиях ниже 2.11. По этой причине мы рекомендуем использовать файл `meta/argument_specs.yml` для обеспечения обратной совместимости.

Note

Когда проверка аргумента роли используется для роли, которая имеет определенные [зависимости](?page=2#role-dependencies) , проверка этих зависимостей будет выполняться перед зависимой ролью, даже если проверка аргумента для зависимой роли завершается ошибкой.

### Specification format

Спецификация аргумента роли должна быть определена в блоке `argument_specs` верхнего уровня в файле `meta/argument_specs.yml` роли . Все поля в нижнем регистре.
```
entry-point-name
```
*   Имя точки входа в роль.
*   Это должно быть `main` в случае неопределенной точки входа.
*   Это будет базовое имя файла задач, который нужно выполнить, без `.yaml` файла `.yml` или .yaml .
```
short_description
```
*   Краткое,однострочное описание точки входа.
*   `short_description` отображается `ansible-doc -t role -l` .
```
description
```
*   Более длинное описание,которое может содержать несколько строк.
```
author
```
*   Имя авторов точки входа.
*   Используйте многострочный список,если в нем более одного автора.
```
options
```
*   Опции часто называют "параметрами" или "аргументами".В этом разделе дается определение этих параметров.
*   Для каждого варианта роли (аргумента)вы можете включить:
```
option-name
```
*   Имя опции/аргумента.
```
description
```
*   Подробное объяснение того,что делает эта опция.Оно должно быть написано полными предложениями.
```
type
```
*   Тип данных опции. По умолчанию `str` .
*   Если опция относится к `list` типов , `elements` должны быть указаны.
```
required
```
*   Требуется только в том случае, если это `true` .
*   Если опция отсутствует,она не требуется.
```
default
```
*   Если `required` значение равно false/отсутствует, можно указать `default`
*   Убедитесь, что значение по умолчанию в документации соответствует значению по умолчанию в коде. Фактическое значение по умолчанию для переменной роли всегда будет из `defaults/main.yml` .
*   Поле по умолчанию не должно быть указано как часть описания,если оно не требует дополнительной информации или условий.
*   Если опция является булевым значением,вы можете использовать любое из булевых значений,распознаваемых Ansible:(например,true/false или yes/no).Выберите то,которое лучше читается в контексте опции.
```
choices
```
*   Список значений опций.
*   Должен отсутствовать,если пуст.
```
elements
```
*   Задает тип данных для элементов списка, если тип - `list` .
```
options
```
*   Если эта опция принимает dict или список dicts,вы можете определить структуру здесь.
```
* * *
```

  


