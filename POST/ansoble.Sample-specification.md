Sample specification
====================
```
# roles/myapp/meta/argument_specs.yml
---
argument_specs:
  # роли / myapp / tasks / точка входа main.yml
  main:
    short_description: The main entry point for the myapp role.
    options:
      myapp_int:
        type: "int"
        required: false
        default: 42
        description: "The integer value, defaulting to 42."

      myapp_str:
        type: "str"
        required: true
        description: "The string value"

  # роли / maypp / tasks / alternate.yml точка входа
  alternate:
    short_description: The alternate entry point for the myapp role.
    options:
      myapp_int:
        type: "int"
        required: false
        default: 1024
        description: "The integer value, defaulting to 1024."
```

Запуск роли несколько раз в одной пьесе.
----------------------------------------

Ansible выполняет каждую роль только один раз, даже если вы определяете ее несколько раз, если только параметры, определенные для роли, не отличаются для каждого определения. Например, Ansible запускает роль `foo` только один раз в такой игре:
```
---
- hosts: webservers
  roles:
    - foo
    - bar
    - foo
```
У вас есть два варианта,чтобы заставить Ansible выполнять роль не один раз.

### Передача различных параметров

Если вы передаете разные параметры в каждом определении роли, Ansible запускает роль более одного раза. Предоставление разных значений переменных - это не то же самое, что передача разных параметров роли. Для этого поведения необходимо использовать ключевое слово `roles` , поскольку `import_role` и `include_role` не принимают параметры роли.

Этот сценарий дважды запускает роль `foo` :
```
---
- hosts: webservers
  roles:
    - { role: foo, message: "first" }
    - { role: foo, message: "second" }
```
Этот синтаксис также дважды запускает роль `foo` ;
```
---
- hosts: webservers
  roles:
    - role: foo
      message: "first"
    - role: foo
      message: "second"
```
В этих примерах Ansible запускает `foo` дважды, потому что каждое определение роли имеет разные параметры.

### Использование `allow_duplicates: true`

Добавьте `allow_duplicates: true` в файл `meta/main.yml` для роли:
```
# playbook.yml
---
- hosts: webservers
  roles:
    - foo
    - foo
```
```
# roles/foo/meta/main.yml
---
allow_duplicates: true
```
В этом примере Ansible запускает `foo` дважды, потому что мы явно разрешили ему это делать.

Использование ролевых зависимостей
----------------------------------

Зависимости ролей позволяют автоматически подключаться к другим ролям при использовании роли. Ansible не выполняет зависимости ролей, когда вы включаете или импортируете роль. Вы должны использовать ключевое слово `roles` если хотите, чтобы Ansible выполнял зависимости ролей.

Зависимости ролей - это предварительные условия, а не настоящие зависимости. Роли не имеют отношений родитель / потомок. Ansible загружает все перечисленные роли, сначала запускает роли, перечисленные в `dependencies` , а затем запускает роль, которая их перечисляет. Объект воспроизведения является родительским для всех ролей, включая роли, вызываемые списком `dependencies` .

Зависимости ролей хранятся в файле `meta/main.yml` в каталоге ролей. Этот файл должен содержать список ролей и параметров, которые нужно вставить перед указанной ролью. Например:
```
# roles/myapp/meta/main.yml
---
dependencies:
  - role: common
    vars:
      some_parameter: 3
  - role: apache
    vars:
      apache_port: 80
  - role: postgres
    vars:
      dbname: blarg
      other_parameter: 12
```
Ansible всегда выполняет роли, перечисленные в `dependencies` перед ролью, которая их перечисляет. Ansible рекурсивно выполняет этот шаблон, когда вы используете ключевое слово `roles` . Например, если вы перечисляете роль `foo` в разделе « `roles:` , «role `foo` » перечисляет `bar` ролей под `dependencies` в своем файле meta / main.yml, а `bar` ролей перечисляет роль `baz` под `dependencies` в своем файле meta / main.yml, Ansible выполняет `baz` , затем `bar` , затем `foo` .

### Многократные ролевые зависимости в одной пьесе.

Ansible обрабатывает повторяющиеся зависимости ролей, как повторяющиеся роли, перечисленные в `roles:` Ansible выполняет зависимости ролей только один раз, даже если они определены несколько раз, если только параметры, теги или предложение when, определенные для роли, не различаются для каждого определения. Если две роли в playbook указывают третью роль как зависимость, Ansible запускает эту зависимость только один раз, если вы не передаете другие параметры, теги, предложение when или не используете `allow_duplicates: true` в роли, которую хотите запускать несколько раз. См. Дополнительные сведения в разделе « [Зависимости ролей Galaxy»](../galaxy/user_guide#galaxy-dependencies) .

Note

Дедупликация ролей не проверяет сигнатуру вызова родительских ролей. Кроме того, при использовании `vars:` вместо параметров роли возникает побочный эффект изменения области видимости переменной. Использование `vars:` приводит к тому, что эти переменные ограничиваются на уровне игры. В приведенном ниже примере использование `vars:` приведет к тому, что `n` будет определено как `4` во всей игре, включая роли, вызванные перед ней.

В дополнение к вышесказанному, пользователи должны знать, что дедупликация ролей происходит до оценки переменных. Это означает, что [Lazy Evaluation](https://docs.ansible.com/ansible/latest/reference_appendices/glossary.html#term-Lazy-Evaluation) может сделать, казалось бы, разные вызовы ролей одинаково одинаковыми, предотвращая запуск роли более одного раза.

Например, роль с именем `car` зависит от роли с именем `wheel` следующим образом:
```
---
dependencies:
  - role: wheel
    n: 1
  - role: wheel
    n: 2
  - role: wheel
    n: 3
  - role: wheel
    n: 4
```
А роль `wheel` зависит от двух ролей: `tire` и `brake` . Тогда `meta/main.yml` для wheel будет содержать следующее:
```
---
dependencies:
  - role: tire
  - role: brake
```
И `meta/main.yml` для `tire` и `brake` будет содержать следующее:
```
---
allow_duplicates: true
```
В результате порядок выполнения будет следующим:
```
tire(n=1)
brake(n=1)
wheel(n=1)
tire(n=2)
brake(n=2)
wheel(n=2)
...
car
```
Чтобы использовать `allow_duplicates: true` с зависимостями ролей, необходимо указать его для роли, указанной в разделе `dependencies` , а не для роли, в которой он указан. В приведенном выше примере, `allow_duplicates: true` появляется в `meta/main.yml` из `tire` и `brake` ролей. `wheel` роль не требует `allow_duplicates: true` , потому что каждый экземпляр определяется `car` использует различные значения параметров.
```
Note
```
См. [Использование переменных](playbooks_variables#playbooks-variables) для получения подробной информации о том, как Ansible выбирает значения переменных, определенных в разных местах (наследование переменных и область видимости).

Встраиваемые модули и плагины в ролях
-------------------------------------

Если вы пишете пользовательский модуль (см. [«Нужно ли вам разработать модуль?»](https://docs.ansible.com/ansible/latest/dev_guide/developing_modules.html#developing-modules) ) или подключаемый модуль (см. « [Разработка](https://docs.ansible.com/ansible/latest/dev_guide/developing_plugins.html#developing-plugins) подключаемых модулей» ), вы можете захотеть распространять его как часть роли. Например, если вы пишете модуль, который помогает настроить внутреннее программное обеспечение вашей компании, и вы хотите, чтобы другие люди в вашей организации использовали этот модуль, но вы не хотите рассказывать всем, как настроить путь к своей библиотеке Ansible, вы можете включить модуль в вашей роли internal\_config.

Чтобы добавить модуль или плагин к роли:Наряду со структурой 'tasks' и 'handlers' роли,добавьте каталог с именем 'library',а затем включите модуль непосредственно в каталог 'library'.

Если предположить,что у тебя это было:
```
roles/
    my_custom_modules/
        library/
            module1
            module2
```
Модуль будет использоваться в самой роли, а также в любых ролях, которые вызываются _после_ этой роли, следующим образом:
```
---
- hosts: webservers
  roles:
    - my_custom_modules
    - some_other_role_using_my_custom_modules
    - yet_another_role_using_my_custom_modules
```
При необходимости вы также можете внедрить модуль в роль,чтобы изменить модуль в основном дистрибутиве Ansible.Например,вы можете использовать версию разработки определенного модуля до того,как он будет выпущен в производственных релизах,скопировав модуль и внедрив его копию в роль.Используйте этот подход с осторожностью,поскольку сигнатуры API могут меняться в основных компонентах,и работа этого обходного пути не гарантирована.

Этот же механизм может быть использован для встраивания и распределения плагинов в роли,используя ту же самую схему.Например,для плагина-фильтра:
```
roles/
    my_custom_filter/
        filter_plugins
            filter1
            filter2
```
Затем эти фильтры могут быть использованы в шаблоне Jinja в любой роли,названной после 'my\_custom\_filter'.

Разделение ролей:Допустимая Галактика
-------------------------------------

[Ansible Galaxy](https://galaxy.ansible.com) - это бесплатный сайт для поиска, загрузки, оценки и обзора всех видов ролей Ansible, разработанных сообществом, и может стать отличным способом начать работу над вашими проектами автоматизации.

Клиент `ansible-galaxy` включен в Ansible. Клиент Galaxy позволяет загружать роли из Ansible Galaxy, а также предоставляет отличную среду по умолчанию для создания собственных ролей.

Прочитайте страницу [документации Ansible Galaxy](https://galaxy.ansible.com/docs/) для получения дополнительной информации

