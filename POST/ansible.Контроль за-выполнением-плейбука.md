Контроль за выполнением плейбука:стратегии и многое другое
==========================================================

По умолчанию Ansible запускает каждую задачу на всех хостах, затронутых игрой, перед запуском следующей задачи на любом хосте, используя 5 вилок. Если вы хотите изменить это поведение по умолчанию, вы можете использовать другой плагин стратегии, изменить количество вилок или применить одно из нескольких ключевых слов, например `serial` .

*   [Выбор стратегии](#selecting-a-strategy)
*   [Установка количества вил](#setting-the-number-of-forks)
*   [Использование ключевых слов для контроля исполнения](#using-keywords-to-control-execution)
    
    *   [Установка размера партии с `serial`](#setting-the-batch-size-with-serial)
    *   [Ограничение исполнения с `throttle`](#restricting-execution-with-throttle)
    *   [Выполнение заказов на основе инвентаризации](#ordering-execution-based-on-inventory)
    *   [Запуск на одной машине с `run_once`](#running-on-a-single-machine-with-run-once)

Выбор стратегии
---------------

Описанное выше поведение по умолчанию - это [линейная стратегия](../collections/ansible/builtin/linear_strategy#linear-strategy) . Ansible предлагает другие стратегии, в том числе [стратегию отладки](../collections/ansible/builtin/debug_strategy#debug-strategy) (см. Также « [Задачи отладки»](playbooks_debugger#playbook-debugger) ) и [бесплатную стратегию](../collections/ansible/builtin/free_strategy#free-strategy) , которая позволяет каждому хосту работать до конца игры так быстро, насколько это возможно:
```
- hosts: all
  strategy: free
  tasks:
  ...
```
Вы можете выбрать различную стратегию для каждой игры, как показано выше, или установить предпочитаемую стратегию глобально в `ansible.cfg` в разделе по `defaults` :
```
[defaults]
strategy = free
```
Все стратегии реализованы в виде [плагинов стратегий](../plugins/strategy#strategy-plugins) . Пожалуйста, просмотрите документацию для каждого плагина стратегии, чтобы узнать, как он работает.

Установка количества вил
------------------------

Если у вас есть доступная вычислительная мощность и вы хотите использовать больше вилок, вы можете установить число в `ansible.cfg` :
```
[defaults]
forks = 30
```
или передайте его в командной строке: `ansible-playbook -f 30 my_playbook.yml` .

Использование ключевых слов для контроля исполнения
---------------------------------------------------

Помимо стратегий, на выполнение игры также влияют несколько [ключевых слов](../reference_appendices/playbooks_keywords#playbook-keywords) . Вы можете установить число, процент или список номеров хостов, которыми вы хотите управлять одновременно, с помощью `serial` . Ansible завершает игру на указанном количестве или процентном соотношении хостов перед запуском следующей группы хостов. Вы можете ограничить количество рабочих, выделенных для блока или задачи с помощью `throttle` . Вы можете контролировать, как Ansible выбирает следующего хоста в группе для выполнения по `order` . Вы можете запустить задачу на одном хосте с `run_once` . Эти ключевые слова не являются стратегиями. Это директивы или параметры, применяемые к игре, блоку или задаче.

### Установка размера партии с `serial`

По умолчанию Ansible работает параллельно со всеми хостами в [шаблоне, который](intro_patterns#intro-patterns) вы задали в поле `hosts:` для каждой игры. Если вы хотите управлять только несколькими компьютерами одновременно, например, во время непрерывного обновления, вы можете определить, сколько хостов должен управлять Ansible одновременно, используя ключевое слово `serial` :
```
---
- name: test play
  hosts: webservers
  serial: 3
  gather_facts: False

  tasks:
    - name: first task
      command: hostname
    - name: second task
      command: hostname
```
В приведенном выше примере,если бы у нас было 6 хостов в группе 'webservers',Ansible выполнил бы пьесу полностью (обе задачи)на 3 из хостов,прежде чем переходить к следующим 3 хостам:
```
PLAY [webservers] \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*

TASK [first task] \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*
changed: [web3]
changed: [web2]
changed: [web1]

TASK [second task] \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*
changed: [web1]
changed: [web2]
changed: [web3]

PLAY [webservers] \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*

TASK [first task] \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*
changed: [web4]
changed: [web5
changed: [web6]

TASK [second task\] \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*
changed: [web4]
changed: [web5]
changed: [web2]

PLAY RECAP \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*
web1      : ok=2    changed=2    unreachable=0    failed=0
web2      : ok=2    changed=2    unreachable=0    failed=0
web3      : ok=2    changed=2    unreachable=0    failed=0
web4      : ok=2    changed=2    unreachable=0    failed=0
web5      : ok=2    changed=2    unreachable=0    failed=0
web6      : ok=2    changed=2    unreachable=0    failed=0
```
Вы также можете указать процент с помощью ключевого слова `serial` . Ansible применяет процентное соотношение к общему количеству хостов в игре, чтобы определить количество хостов за проход:
```
---
- name: test play
  hosts: webservers
  serial: "30%"
```
Если количество хостов не делится поровну на количество проходов,то итоговый проход содержит остаток.В данном примере,если у вас 20 хостов в группе веб серверов,то первая партия будет содержать 6 хостов,вторая-6 хостов,третья-6 хостов,а последняя-2 хоста.

Вы также можете указать размеры партий в виде списка.Например:
```
---
- name: test play
  hosts: webservers
  serial:
    - 1
    - 5
    - 10
```
В приведенном выше примере,первая партия будет содержать один хост,следующая-5 хостов,и (если осталось хостов)каждая следующая партия будет содержать либо 10 хостов,либо все остальные,если осталось менее 10 хостов.

Вы можете перечислить несколько размеров партии в процентах:
```
---
- name: test play
  hosts: webservers
  serial:
    - "10%"
    - "20%"
    - "100%"
```
Вы также можете смешивать и сопоставлять значения:
```
---
- name: test play
  hosts: webservers
  serial:
    - 1
    - 5
    - "20%"
```
```
Note
```
Независимо от того,какой маленький процент,количество хостов за один проход всегда будет 1 или больше.

### Ограничение исполнения с `throttle`

`throttle` ключевое слово ограничивает количество рабочих для выполнения конкретной задачи. Его можно установить на уровне блока и задачи. Используйте `throttle` чтобы ограничить задачи, которые могут загружать процессор или взаимодействовать с API, ограничивающим скорость:
```
tasks:
- command: /path/to/cpu_intensive_command
  throttle: 1
```
Если вы уже ограничили количество вилок или количество машин, выполняемых параллельно, вы можете уменьшить количество рабочих процессов с помощью `throttle` , но вы не можете его увеличить. Другими словами, чтобы иметь эффект, настройка `throttle` должна быть ниже, чем настройки `forks` или `serial` порта, если вы используете их вместе.

### Выполнение заказов на основе инвентаризации

`order` ключевых слов определяет порядок , в котором запускаются хозяева. Возможные значения для заказа:
```
inventory:
```
(по умолчанию) Порядок, указанный в инвентаре
```
reverse_inventory:
```
Обратный порядок,предусмотренный инвентаризацией
```
sorted:
```
Отсортировано в алфавитном порядке по названию
```
reverse_sorted:
```
Сортировать по имени в обратном алфавитном порядке
```
shuffle:
```
Случайно заказанный на каждом пробеге

Другие ключевые слова, влияющие на выполнение воспроизведения, включают `ignore_errors` , `ignore_unreachable` и `any_errors_fatal` . Эти параметры описаны в [разделе «Обработка ошибок в учебниках»](playbooks_error_handling#playbooks-error-handling) .

### Запуск на одной машине с `run_once`

Если вы хотите, чтобы задача выполнялась только на первом хосте в вашем пакете хостов, установите для `run_once` значение true для этой задачи:
```
---
# ...
  tasks:
    # ...
    - command: /opt/application/upgrade_db.py
      run_once: true

    # ...
```
Возможность выполнить эту задачу на первом хосте в текущем пакете и применить все результаты и факты ко всем хостам в одном пакете.Такой подход похож на применение условия к такой задаче:
```
- command: /opt/application/upgrade_db.py
  when: inventory_hostname == webservers[0]
```
Однако с `run_once` результаты применяются ко всем хостам. Чтобы запустить задачу на определенном хосте, вместо первого хоста в пакете делегируйте задачу:
```
- command: /opt/application/upgrade_db.py
  run_once: true
  delegate_to: web01.example.org
```
Как всегда с [делегированием](playbooks_delegation#playbooks-delegation) , действие будет выполнено на делегированном хосте, но информация останется той же информацией, что и исходный хост в задаче.
```
Note
```
При использовании вместе с `serial` `run_once` задачи, отмеченные как run\_once, будут запускаться на одном хосте в _каждом_ последовательном пакете. Если задача должна запускаться только один раз, независимо от `serial` режима, используйте конструкцию `when: inventory_hostname == ansible_play_hosts_all[0]` .
```
Note
```
Любое условие (другими словами, `when:` ) будет использовать переменные «первого хоста», чтобы решить, выполняется задача или нет, никакие другие хосты не будут тестироваться.
```
Note
```
Если вы хотите избежать стандартного поведения установки факта для всех хостов, установите `delegate_facts: True` для конкретной задачи или блока.

