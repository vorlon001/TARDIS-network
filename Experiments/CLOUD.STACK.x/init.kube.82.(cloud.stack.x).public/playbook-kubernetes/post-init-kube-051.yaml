---
# main.yml
- hosts: bootstrap
  tasks:
    - name: Deploy MetalLB
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      community.kubernetes.helm:
        name: cloudstack
        chart_ref: "cloudstack/metallb"
        release_state: present
        update_repo_cache: true
        release_namespace: metallb-system
        create_namespace: yes
        chart_version: "{{METALLB_chart_version}}"
        values:
          prometheus:
            rbacProxy:
              repository: "{{METALLB_prometheus_repository}}"
              tag: "{{METALLB_prometheus_tag}}"
          controller:
            enabled: true
            logLevel: info
            image:
              repository: "{{METALLB_controller_repository}}"
              tag: "{{METALLB_controller_tag}}"
          speaker:
            enabled: true
            logLevel: info
            tolerateMaster: true
            image:
              repository: "{{METALLB_speaker_repository}}"
              tag: "{{METALLB_speaker_tag}}"
            frr:
              enabled: true
              image:
                repository: "{{METALLB_frr_repository}}"
                tag: "{{METALLB_frr_tag}}"
      register: result
    - debug: var=result.stdout_lines

    - name: Sleep 60 second, init CNI
      pause:
        seconds: 60

    - name: Create MetalLB IP Pool
      kubernetes.core.k8s:
        state: present
        apply: true
        template:
          path: 'CNI-METALLB/ippool.yaml.j2'
      loop: "{{ METALLB_ippools | dict2items | subelements('value') }}"
